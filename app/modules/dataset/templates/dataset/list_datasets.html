{% extends "base_template.html" %}
{% set title = "My datasets" %}

{% block breadcrumb %}

<ol class="breadcrumb text-muted fs-6 fw-semibold">
    <li class="breadcrumb-item"><a href="/" class="">Home</a></li>
    <li class="breadcrumb-item text-muted">My datasets</li>
</ol>

{% endblock %}

{% block content %}

{% if datasets %}
<div class="card mb-10">
    <div class="card-header">
        <h3 class="card-title">Synchronized datasets</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table align-middle table-row-dashed gy-5" id="synchronizedDatasetsTable">
                <thead>
                    <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
                        <th>Title</th>
                        <th>Publication type</th>
                        <th>Dataset DOI</th>
                        <th>Created at</th>
                        <th>Options</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 fw-semibold">
                    {% for dataset in datasets %}
                    <tr>
                        <td>
                            <a href="{{ dataset.get_uvlhub_doi() }}">
                                {{ dataset.ds_meta_data.title }}
                            </a>
                            {% if dataset.is_anonymous() %}
                                <span class="badge badge-light-warning ms-2">Anonymous</span>
                            {% endif %}
                        </td>
                        <td>{{ dataset.get_publication() }}</td>
                        <td>
                            <a href="{{ dataset.get_uvlhub_doi() }}" target="_blank">
                                {{ dataset.get_uvlhub_doi() }}
                            </a>
                        </td>
                        <td>{{ dataset.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>
                            <a href="{{ dataset.get_uvlhub_doi() }}" class="btn btn-sm btn-icon btn-light-info me-1" title="View">
                                <i class="ki-duotone ki-eye fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                            </a>
                            <a href="{{ url_for('dataset.download_dataset', dataset_id=dataset.id) }}" class="btn btn-sm btn-icon btn-light-success" title="Download">
                                <i class="ki-duotone ki-folder-down fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <i class="ki-duotone ki-database fs-2 me-2"></i> No synchronized datasets found. 
    <a href="{{ url_for('dataset.create_dataset') }}" class="ms-2">Upload one</a>.
</div>
{% endif %}


{% if local_datasets %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Unsynchronized datasets</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table align-middle table-row-dashed gy-5" id="unsynchronizedDatasetsTable">
                <thead>
                    <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
                        <th>Title</th>
                        <th>Publication type</th>
                        <th>Created at</th>
                        <th>Options</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 fw-semibold">
                    {% for dataset in local_datasets %}
                    <tr>
                        <td>
                            <a href="{{ url_for('dataset.get_unsynchronized_dataset', dataset_id=dataset.id) }}">
                                {{ dataset.ds_meta_data.title }}
                            </a>
                        </td>
                        <td>{{ dataset.get_publication() }}</td>
                        <td>{{ dataset.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>
                            <a href="{{ url_for('dataset.get_unsynchronized_dataset', dataset_id=dataset.id) }}" class="btn btn-sm btn-icon btn-light-info me-1" title="View">
                                <i class="ki-duotone ki-eye fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i></i>
                            </a>
                            <a href="{{ url_for('dataset.download_dataset', dataset_id=dataset.id) }}" class="btn btn-sm btn-icon btn-light-success" title="Download">
                                <i class="ki-duotone ki-folder-down fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </a>
                            <a href="javascript:void(0);" 
                                class="btn btn-sm btn-light-primary me-1 btn-sync d-inline-flex align-items-center"
                                data-dataset-id="{{ dataset.id }}" 
                                title="Sync to Zenodo and make public">
                                <i class="ki-duotone ki-folder-up fs-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                </i>
                                Sync to Zenodo and make public
                            </a>

                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="modal fade" tabindex="-1" id="syncConfirmModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center">
        <i class="ki-duotone ki-folder-up fs-2 me-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
        Confirm sync to Zenodo and make public
        </h5>

        <button type="button" class="btn btn-sm btn-icon" data-bs-dismiss="modal">
          <i class="ki-duotone ki-cross fs-2"></i>
        </button>
      </div>

      <div class="modal-body">
        <p class="fw-semibold text-gray-700">
          Once synchronized, the dataset will be uploaded permanently to Zenodo.  
          <b>This action cannot be undone.</b>
        </p>
        <p class="text-muted fs-7">
          Synchronization with Zenodo is required for your dataset to become public in UVLHub.
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmSyncBtn">
        <i class="ki-duotone ki-folder-up fs-2 me-2">
        <span class="path1"></span>
        <span class="path2"></span>
        </i>
        <span class="btn-text">Sync now</span>
        </button>
      </div>

    </div>
  </div>
</div>


{% endblock %}


{% block scripts %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    let selectedDatasetId = null;
    const syncBtn = document.getElementById("confirmSyncBtn");
    const syncBtnText = syncBtn.querySelector(".btn-text");

    // Abrir modal al pulsar Sync
    $("#unsynchronizedDatasetsTable").on("click", ".btn-sync", function (e) {
        e.preventDefault();
        selectedDatasetId = this.dataset.datasetId;
        const modal = new bootstrap.Modal(document.getElementById('syncConfirmModal'));
        modal.show();
    });

    // Acci贸n de confirmaci贸n
    syncBtn.addEventListener("click", function () {
        if (!selectedDatasetId) return;

        // Cambiar estado del bot贸n
        syncBtn.disabled = true;
        syncBtnText.textContent = "Synchronizing...";
        syncBtn.insertAdjacentHTML("beforeend", '<span class="spinner-border spinner-border-sm ms-2"></span>');

        fetch(`/datasets/sync/${selectedDatasetId}`, {method: "POST"})
            .then(r => r.json())
            .then(data => {
                if (data.doi) {
                    toastr.success("Dataset synchronized! DOI: " + data.doi);
                    location.reload();
                } else {
                    toastr.error(data.error || "Failed to sync dataset.");
                }
            })
            .catch(err => toastr.error("Unexpected error: " + err))
            .finally(() => {
                // restaurar bot贸n si NO recargas
                syncBtn.disabled = false;
                syncBtnText.textContent = "Sync now";
                syncBtn.querySelector(".spinner-border")?.remove();
            });
    });
});
</script>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        $("#synchronizedDatasetsTable").DataTable({
            order: [[3, "desc"]]
        });
        $("#unsynchronizedDatasetsTable").DataTable({
            order: [[2, "desc"]]
        });
    });
</script>
{% endblock %}
